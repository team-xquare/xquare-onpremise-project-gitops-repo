---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana-password-generator
  namespace: {{ include "project.namespace" . }}
  labels:
    {{- include "project.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: grafana-password-generator
  namespace: {{ include "project.namespace" . }}
  labels:
    {{- include "project.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: grafana-password-generator
  namespace: {{ include "project.namespace" . }}
  labels:
    {{- include "project.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: grafana-password-generator
subjects:
- kind: ServiceAccount
  name: grafana-password-generator
  namespace: {{ include "project.namespace" . }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-password-generator
  namespace: {{ include "project.namespace" . }}
  labels:
    {{- include "project.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: generator
        image: alpine/kubectl:latest
        command:
          - /bin/sh
          - -c
          - |
            if ! kubectl get secret grafana-admin-password -n {{ include "project.namespace" . }} 2>/dev/null; then
              RAND=$(head -c 32 /dev/urandom | base64 | tr -d '/+=' | head -c 32)
              kubectl create secret generic grafana-admin-password \
                --from-literal=password=$RAND \
                --namespace={{ include "project.namespace" . }}
            fi
      serviceAccountName: grafana-password-generator
      restartPolicy: OnFailure
---
apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: grafana
  namespace: {{ include "project.namespace" . }}
  labels:
    {{- include "project.labels" . | nindent 4 }}
    dashboards: "grafana"
    app: grafana-instance
spec:
  config:
    log:
      mode: "console"
    auth:
      disable_login_form: "false"
    security:
      admin_user: admin
    plugins:
      plugin_admin_enabled: "true"
    dashboards:
      default_home_dashboard_path: "/dashboards/General/home-dashboard.json"
  deployment:
    spec:
      replicas: 1
      template:
        spec:
          containers:
          - name: grafana
            image: docker.io/grafana/grafana:12.3.0
            env:
            - name: GF_INSTALL_PLUGINS
              value: "victoriametrics-logs-datasource"
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-admin-password
                  key: password
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 1Gi
  service:
    spec:
      type: ClusterIP
      ports:
      - name: grafana
        port: 3000
        protocol: TCP
        targetPort: 3000
