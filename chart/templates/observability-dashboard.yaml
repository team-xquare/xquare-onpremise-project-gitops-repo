{{- range .Values.applications }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: app-{{ .name }}
  namespace: {{ include "project.namespace" $ }}
  labels:
    {{- include "project.labels" $ | nindent 4 }}
spec:
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  json: |
    {
      "title": "{{ .name }} - Application",
      "uid": "app-{{ .name }}",
      "timezone": "browser",
      "schemaVersion": 16,
      "refresh": "30s",
      "time": {"from": "now-1h", "to": "now"},
      "panels": [
        {
          "id": 1,
          "type": "timeseries",
          "title": "CPU Usage (cores)",
          "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",container!=\"POD\",container!=\"\"}[5m])) by (pod)",
            "legendFormat": "{{`{{ pod }}`}}",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "fillOpacity": 10}}}
        },
        {
          "id": 2,
          "type": "timeseries",
          "title": "Memory Usage",
          "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "sum(container_memory_working_set_bytes{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",container!=\"POD\",container!=\"\"}) by (pod)",
            "legendFormat": "{{`{{ pod }}`}}",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "fillOpacity": 10}}}
        },
        {
          "id": 3,
          "type": "logs",
          "title": "Application Logs",
          "gridPos": {"x": 0, "y": 8, "w": 24, "h": 10},
          "targets": [{
            "datasource": {"type": "victoriametrics-logs-datasource", "uid": "victorialogs"},
            "expr": "{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\"}",
            "refId": "A"
          }],
          "options": {"showTime": true, "showLabels": false, "wrapLogMessage": true, "sortOrder": "Descending"}
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Running Pods",
          "gridPos": {"x": 0, "y": 18, "w": 8, "h": 4},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "count(kube_pod_status_phase{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",phase=\"Running\"})",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "thresholds": {"mode": "absolute", "steps": [{"value": null, "color": "green"}]}}}
        },
        {
          "id": 5,
          "type": "stat",
          "title": "Failed Pods",
          "gridPos": {"x": 8, "y": 18, "w": 8, "h": 4},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "count(kube_pod_status_phase{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",phase=\"Failed\"}) or vector(0)",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "thresholds": {"mode": "absolute", "steps": [{"value": null, "color": "green"}, {"value": 1, "color": "red"}]}}}
        },
        {
          "id": 6,
          "type": "stat",
          "title": "Restart Count (24h)",
          "gridPos": {"x": 16, "y": 18, "w": 8, "h": 4},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "sum(increase(kube_pod_container_status_restarts_total{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\"}[24h]))",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "thresholds": {"mode": "absolute", "steps": [{"value": null, "color": "green"}, {"value": 5, "color": "yellow"}, {"value": 10, "color": "red"}]}}}
        }
      ]
    }
{{- end }}
{{- range .Values.addons }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: addon-{{ .name }}
  namespace: {{ include "project.namespace" $ }}
  labels:
    {{- include "project.labels" $ | nindent 4 }}
spec:
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  json: |
    {
      "title": "{{ .name }} - {{ .type | title }}",
      "uid": "addon-{{ .name }}",
      "timezone": "browser",
      "schemaVersion": 16,
      "refresh": "30s",
      "time": {"from": "now-1h", "to": "now"},
      "panels": [
        {
          "id": 1,
          "type": "timeseries",
          "title": "CPU Usage (cores)",
          "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",container!=\"POD\",container!=\"\"}[5m])) by (pod)",
            "legendFormat": "{{`{{ pod }}`}}",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "fillOpacity": 10}}}
        },
        {
          "id": 2,
          "type": "timeseries",
          "title": "Memory Usage",
          "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "sum(container_memory_working_set_bytes{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",container!=\"POD\",container!=\"\"}) by (pod)",
            "legendFormat": "{{`{{ pod }}`}}",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "bytes", "custom": {"drawStyle": "line", "fillOpacity": 10}}}
        },
        {
          "id": 3,
          "type": "logs",
          "title": "Addon Logs",
          "gridPos": {"x": 0, "y": 8, "w": 24, "h": 10},
          "targets": [{
            "datasource": {"type": "victoriametrics-logs-datasource", "uid": "victorialogs"},
            "expr": "{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\"}",
            "refId": "A"
          }],
          "options": {"showTime": true, "showLabels": false, "wrapLogMessage": true, "sortOrder": "Descending"}
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Running Pods",
          "gridPos": {"x": 0, "y": 18, "w": 12, "h": 4},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "count(kube_pod_status_phase{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",phase=\"Running\"})",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "thresholds": {"mode": "absolute", "steps": [{"value": null, "color": "green"}]}}}
        },
        {
          "id": 5,
          "type": "stat",
          "title": "Failed Pods",
          "gridPos": {"x": 12, "y": 18, "w": 12, "h": 4},
          "targets": [{
            "datasource": {"type": "prometheus", "uid": "victoriametrics"},
            "expr": "count(kube_pod_status_phase{namespace=\"{{ include "project.namespace" $ }}\",pod=~\"{{ .name }}-.*\",phase=\"Failed\"}) or vector(0)",
            "refId": "A"
          }],
          "fieldConfig": {"defaults": {"unit": "short", "thresholds": {"mode": "absolute", "steps": [{"value": null, "color": "green"}, {"value": 1, "color": "red"}]}}}
        }
      ]
    }
{{- end }}
