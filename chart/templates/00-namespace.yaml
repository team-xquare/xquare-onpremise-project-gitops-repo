---
apiVersion: v1
kind: Namespace
metadata:
  name: {{ include "project.namespace" . }}
  labels:
    {{- include "project.labels" . | nindent 4 }}
    name: {{ include "project.namespace" . }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: namespace-labeler
  namespace: {{ include "project.namespace" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: namespace-labeler-{{ include "project.namespace" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: namespace-labeler-{{ include "project.namespace" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: namespace-labeler-{{ include "project.namespace" . }}
subjects:
- kind: ServiceAccount
  name: namespace-labeler
  namespace: {{ include "project.namespace" . }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: namespace-labeler
  namespace: {{ include "project.namespace" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      serviceAccountName: namespace-labeler
      restartPolicy: OnFailure
      containers:
      - name: labeler
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          NAMESPACE="{{ include "project.namespace" . }}"

          TENANT_ID=$(echo -n "$NAMESPACE" | cksum | awk '{print $1}')

          COUNTER=0
          MAX_ATTEMPTS=1000

          while [ $COUNTER -lt $MAX_ATTEMPTS ]; do
            CONFLICT=0

            for ns in $(kubectl get namespaces -o name | grep '/.*-dsm-project$' | cut -d'/' -f2); do
              if [ "$ns" = "$NAMESPACE" ]; then
                continue
              fi

              existing_id=$(kubectl get namespace "$ns" -o jsonpath='{.metadata.labels.tenant-id}' 2>/dev/null || echo "")

              if [ -n "$existing_id" ] && [ "$existing_id" = "$TENANT_ID" ]; then
                CONFLICT=1
                break
              fi
            done

            if [ $CONFLICT -eq 0 ]; then
              break
            fi

            COUNTER=$((COUNTER + 1))
            TENANT_ID=$(echo -n "${NAMESPACE}-${COUNTER}" | cksum | awk '{print $1}')
          done

          if [ $COUNTER -ge $MAX_ATTEMPTS ]; then
            echo "Error: Could not find unique tenant-id after $MAX_ATTEMPTS attempts"
            exit 1
          fi

          echo "Assigning tenant-id=$TENANT_ID to namespace $NAMESPACE"
          kubectl label namespace "$NAMESPACE" tenant-id="$TENANT_ID" --overwrite
  backoffLimit: 3
