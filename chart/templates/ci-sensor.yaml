{{- range .Values.applications }}
---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: {{ include "app.serviceName" . }}-sensor
  namespace: {{ include "project.namespace" $ }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: ci-sensor
spec:
  dependencies:
    - name: {{ include "app.serviceName" . }}-github-event
      eventName: {{ include "ci.githubFullname" . }}
      eventSourceName: {{ include "app.serviceName" . }}-github-webhook
      filters:
        data:
          - path: body.ref
            type: string
            value:
              - "refs/heads/{{ .github.branch }}"
          - path: body.X-GitHub-Event
            type: string
            value:
              - "ping"
        dataLogicalOperator: "or"
  
  eventBusName: ci-eventbus
  template:
    serviceAccountName: kaniko-sa
    container:
      resources:
        requests:
          cpu: 10m
          memory: 30Mi
        limits:
          cpu: 50m
          memory: 60Mi
  
  triggers:
    - retryStrategy:
        steps: 3
      template:
        k8s:
          operation: create
          parameters:
            - src:
                dependencyName: {{ include "app.serviceName" . }}-github-event
                dataKey: body.X-GitHub-Event
                value: ""
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: {{ include "app.serviceName" . }}-github-event
                dataKey: body.after
                value: ""
              dest: spec.arguments.parameters.1.value
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: {{ include "app.serviceName" . }}-ci-
                namespace: {{ include "project.namespace" $ }}
                labels:
                  {{- include "app.selectorLabels" . | nindent 18 }}
                  app.kubernetes.io/component: ci-workflow
              spec:
                workflowTemplateRef:
                  name: {{ include "app.serviceName" . }}-ci-pipeline-template
                arguments:
                  parameters:
                    - name: github-event-type
                      value: ""
                    - name: github-sha
                      value: ""
                    - name: service-name
                      value: {{ include "app.serviceName" . }}
                    - name: project-name
                      value: {{ $.Values.project }}
                    - name: github-owner
                      value: {{ .github.owner }}
                    - name: github-repo
                      value: {{ .github.repo }}
                    - name: github-branch
                      value: {{ .github.branch }}
                    - name: harbor-registry
                      value: {{ include "project.harborRegistry" $ }}
                    - name: gitops-repo
                      value: {{ include "ci.gitopsRepo" $ }}
                    - name: docker-context-path
                      value: {{ if .build.docker }}{{ .build.docker.sourcePath | default "" }}{{ end }}
                podGC:
                  strategy: OnPodCompletion
                  deleteDelayDuration: 72h
                serviceAccountName: kaniko-sa
        name: {{ include "app.serviceName" . }}-workflow-trigger
{{- end }}