{{- range .Values.applications }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.serviceName" . }}-dockerfile
  namespace: {{ include "project.namespace" $ }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: dockerfile
data:
  Dockerfile.generated: |
{{- if .build.gradle }}
    # syntax=docker/dockerfile:1.10
    FROM eclipse-temurin:{{ .build.gradle.javaVersion }}-jdk-alpine AS deps
    WORKDIR /app
    RUN apk add --no-cache bash findutils gcompat
    COPY ./build.gradle* ./settings.gradle* ./gradle.properties* ./gradlew* ./
    RUN --mount=type=bind,source=gradle,target=/tmp/gradle cp -r /tmp/gradle . 2>/dev/null || mkdir -p gradle
    RUN chmod +x gradlew 2>/dev/null || chmod +x ./gradlew 2>/dev/null || true
    RUN --mount=type=cache,target=/root/.gradle,sharing=locked ./gradlew dependencies --no-daemon 2>/dev/null || true
    FROM eclipse-temurin:{{ .build.gradle.javaVersion }}-jdk-alpine AS build
    WORKDIR /app
    RUN apk add --no-cache bash findutils gcompat
    ENV GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"
    COPY ./build.gradle* ./settings.gradle* ./gradle.properties* ./gradlew* ./
    RUN --mount=type=bind,source=gradle,target=/tmp/gradle cp -r /tmp/gradle . 2>/dev/null || mkdir -p gradle
    COPY ./ .
    RUN --mount=type=cache,target=/root/.gradle,sharing=locked chmod +x gradlew 2>/dev/null || true && {{ .build.gradle.buildCommand }} --no-daemon
    FROM eclipse-temurin:{{ .build.gradle.javaVersion }}-jdk-alpine AS extract
    WORKDIR /extract
    RUN apk add --no-cache unzip
    COPY --from=build /app{{ .build.gradle.jarOutputPath | default "/build/libs/*.jar" }} app.jar
    RUN set -ex && if java -Djarmode=tools -jar app.jar list-layers >/dev/null 2>&1; then java -Djarmode=tools -jar app.jar extract --layers --destination /extract; elif java -Djarmode=layertools -jar app.jar list >/dev/null 2>&1; then java -Djarmode=layertools -jar app.jar extract --destination /extract; else mkdir -p dependencies spring-boot-loader snapshot-dependencies application && unzip -q app.jar && [ -d BOOT-INF/lib ] && mv BOOT-INF/lib/* dependencies/ 2>/dev/null || true && find dependencies/ -name '*-SNAPSHOT.jar' -exec mv {} snapshot-dependencies/ \; 2>/dev/null || true && [ -d org/springframework/boot/loader ] && mkdir -p spring-boot-loader/org/springframework/boot && mv org/springframework/boot/loader spring-boot-loader/org/springframework/boot/ 2>/dev/null || true && [ -d BOOT-INF/classes ] && mv BOOT-INF/classes/* application/ 2>/dev/null || true && [ -d META-INF ] && mv META-INF application/ 2>/dev/null || true; fi && rm -f app.jar
    FROM eclipse-temurin:{{ .build.gradle.javaVersion }}-jre-alpine
    RUN apk add --no-cache tzdata curl ca-certificates && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser && rm -rf /var/cache/apk/*
    WORKDIR /app
    ENV TZ=Asia/Seoul JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -Djava.security.egd=file:/dev/./urandom" JAVA_TOOL_OPTIONS="-XX:+ExitOnOutOfMemoryError"
    COPY --from=extract --chown=appuser:appgroup /extract/dependencies/ ./
    COPY --from=extract --chown=appuser:appgroup /extract/spring-boot-loader/ ./
    COPY --from=extract --chown=appuser:appgroup /extract/snapshot-dependencies/ ./
    COPY --from=extract --chown=appuser:appgroup /extract/application/ ./
    USER appuser
    ENTRYPOINT ["sh","-c","exec java $JAVA_OPTS org.springframework.boot.loader.launch.JarLauncher 2>/dev/null || exec java $JAVA_OPTS org.springframework.boot.loader.JarLauncher"]
{{- else if .build.nodejs }}
    FROM node:{{ .build.nodejs.nodeVersion }}-alpine AS build
    RUN corepack enable
    WORKDIR /app
    COPY ./ .
    RUN {{ .build.nodejs.buildCommand }}
    FROM node:{{ .build.nodejs.nodeVersion }}-alpine
    RUN apk add --no-cache dumb-init && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    WORKDIR /app
    COPY --from=build --chown=appuser:appgroup /app .
    USER appuser
    ENTRYPOINT ["dumb-init", "--"]
    {{- $startCmd := (splitList " " (.build.nodejs.startCommand | default "npm start")) }}
    CMD [{{- range $i, $cmd := $startCmd }}{{if $i}}, {{end}}"{{ $cmd }}"{{- end }}]
{{- else if .build.react }}
    FROM node:{{ .build.react.nodeVersion }}-alpine AS build
    RUN corepack enable
    RUN apk add --no-cache coreutils
    WORKDIR /app
    COPY ./ .
    RUN (find . -maxdepth 2 -name ".env*" -type f -exec grep -oE '^[A-Z_][A-Z0-9_]*=' {} + 2>/dev/null | sed 's/=$//' && \
      find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
      ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/build/*" ! -path "*/dist/*" \
      ! -path "*/.yarn/*" ! -path "*/.next/*" ! -path "*/.cache/*" ! -path "*/.turbo/*" \
      ! -path "*/coverage/*" ! -path "*/out/*" \
      -exec grep -ohE 'process\.env\.[A-Z_][A-Z0-9_]*|import\.meta\.env\.[A-Z_][A-Z0-9_]*' {} + 2>/dev/null | \
      sed -e 's/process\.env\.//' -e 's/import\.meta\.env\.//') | sort -u | \
      grep -vE '^(NODE_ENV|PUBLIC_URL|PATH|HOME|USER|SHELL|TERM|LANG|LC_ALL|PWD|OLDPWD|TMPDIR|MODE|DEV|PROD|SSR|BASE_URL)$' | \
      while read var; do \
        uuid=$(echo -n "$var" | md5sum | cut -d' ' -f1); \
        echo "$var=__ENV_NOT_SET__${var}__${uuid}__"; \
      done > /tmp/.env.mappings && \
      echo "Found env vars: $(cat /tmp/.env.mappings | cut -d'=' -f1 | tr '\n' ' ')"
    RUN export $(cat /tmp/.env.mappings | xargs) && {{ .build.react.buildCommand }}
    FROM nginx:alpine
    RUN apk add --no-cache tzdata wget && addgroup -g 101 nginx-group || true && adduser -u 101 -G nginx-group -s /bin/sh -D nginx-user || true
    COPY --from=build /app{{ .build.react.distPath | default "/build" }} /usr/share/nginx/html
    COPY --from=build /tmp/.env.mappings /.env.mappings
    RUN echo 'server { listen 8080; server_name _; root /usr/share/nginx/html; index index.html; add_header X-Frame-Options "SAMEORIGIN" always; add_header X-Content-Type-Options "nosniff" always; add_header X-XSS-Protection "1; mode=block" always; gzip on; gzip_vary on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript; location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { expires 1y; add_header Cache-Control "public, immutable"; } location / { try_files $uri $uri/ /index.html; } location /health { access_log off; return 200 "healthy\\n"; add_header Content-Type text/plain; } }' > /etc/nginx/conf.d/default.conf
    RUN rm -f /etc/nginx/conf.d/default.conf.default
    RUN printf '#!/bin/sh\nset -e\nif [ ! -f /.env.mappings ] || [ ! -s /.env.mappings ]; then\n  exit 0\nfi\nsed_script="/tmp/replace.sed"\n> "$sed_script"\nwhile IFS='\''='\'' read -r key placeholder; do\n  value=$(printenv "$key" || echo "")\n  if [ -n "$value" ]; then\n    escaped=$(printf '\''%%s\\n'\'' "$value" | sed '\''s/[&/\\]/\\\\&/g'\'')\n    echo "s|$placeholder|$escaped|g" >> "$sed_script"\n  fi\ndone < /.env.mappings\nif [ -s "$sed_script" ]; then\n  find /usr/share/nginx/html -type f -name "*.js" -exec sed -i -f "$sed_script" {} +\nfi\nrm -f "$sed_script"\n' > /docker-entrypoint.d/40-inject-env.sh
    RUN chmod +x /docker-entrypoint.d/40-inject-env.sh
    CMD ["nginx", "-g", "daemon off;"]
{{- else if .build.vite }}
    FROM node:{{ .build.vite.nodeVersion }}-alpine AS build
    RUN corepack enable
    RUN apk add --no-cache coreutils
    WORKDIR /app
    COPY ./ .
    RUN (find . -maxdepth 2 -name ".env*" -type f -exec grep -oE '^[A-Z_][A-Z0-9_]*=' {} + 2>/dev/null | sed 's/=$//' && \
      find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
      ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/build/*" ! -path "*/dist/*" \
      ! -path "*/.yarn/*" ! -path "*/.next/*" ! -path "*/.cache/*" ! -path "*/.turbo/*" \
      ! -path "*/coverage/*" ! -path "*/out/*" \
      -exec grep -ohE 'process\.env\.[A-Z_][A-Z0-9_]*|import\.meta\.env\.[A-Z_][A-Z0-9_]*' {} + 2>/dev/null | \
      sed -e 's/process\.env\.//' -e 's/import\.meta\.env\.//') | sort -u | \
      grep -vE '^(NODE_ENV|PUBLIC_URL|PATH|HOME|USER|SHELL|TERM|LANG|LC_ALL|PWD|OLDPWD|TMPDIR|MODE|DEV|PROD|SSR|BASE_URL)$' | \
      while read var; do \
        uuid=$(echo -n "$var" | md5sum | cut -d' ' -f1); \
        echo "$var=__ENV_NOT_SET__${var}__${uuid}__"; \
      done > /tmp/.env.mappings && \
      echo "Found env vars: $(cat /tmp/.env.mappings | cut -d'=' -f1 | tr '\n' ' ')"
    RUN export $(cat /tmp/.env.mappings | xargs) && {{ .build.vite.buildCommand }}
    FROM nginx:alpine
    RUN apk add --no-cache tzdata wget && addgroup -g 101 nginx-group || true && adduser -u 101 -G nginx-group -s /bin/sh -D nginx-user || true
    COPY --from=build /app{{ .build.vite.distPath | default "/dist" }} /usr/share/nginx/html
    COPY --from=build /tmp/.env.mappings /.env.mappings
    RUN echo 'server { listen 8080; server_name _; root /usr/share/nginx/html; index index.html; add_header X-Frame-Options "SAMEORIGIN" always; add_header X-Content-Type-Options "nosniff" always; add_header X-XSS-Protection "1; mode=block" always; gzip on; gzip_vary on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript; location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { expires 1y; add_header Cache-Control "public, immutable"; } location / { try_files $uri $uri/ /index.html; } location /health { access_log off; return 200 "healthy\\n"; add_header Content-Type text/plain; } }' > /etc/nginx/conf.d/default.conf
    RUN rm -f /etc/nginx/conf.d/default.conf.default
    RUN printf '#!/bin/sh\nset -e\nif [ ! -f /.env.mappings ] || [ ! -s /.env.mappings ]; then\n  exit 0\nfi\nsed_script="/tmp/replace.sed"\n> "$sed_script"\nwhile IFS='\''='\'' read -r key placeholder; do\n  value=$(printenv "$key" || echo "")\n  if [ -n "$value" ]; then\n    escaped=$(printf '\''%%s\\n'\'' "$value" | sed '\''s/[&/\\]/\\\\&/g'\'')\n    echo "s|$placeholder|$escaped|g" >> "$sed_script"\n  fi\ndone < /.env.mappings\nif [ -s "$sed_script" ]; then\n  find /usr/share/nginx/html -type f -name "*.js" -exec sed -i -f "$sed_script" {} +\nfi\nrm -f "$sed_script"\n' > /docker-entrypoint.d/40-inject-env.sh
    RUN chmod +x /docker-entrypoint.d/40-inject-env.sh
    CMD ["nginx", "-g", "daemon off;"]
{{- else if .build.vue }}
    FROM node:{{ .build.vue.nodeVersion }}-alpine AS build
    RUN corepack enable
    RUN apk add --no-cache coreutils
    WORKDIR /app
    COPY ./ .
    RUN (find . -maxdepth 2 -name ".env*" -type f -exec grep -oE '^[A-Z_][A-Z0-9_]*=' {} + 2>/dev/null | sed 's/=$//' && \
      find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
      ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/build/*" ! -path "*/dist/*" \
      ! -path "*/.yarn/*" ! -path "*/.next/*" ! -path "*/.cache/*" ! -path "*/.turbo/*" \
      ! -path "*/coverage/*" ! -path "*/out/*" \
      -exec grep -ohE 'process\.env\.[A-Z_][A-Z0-9_]*|import\.meta\.env\.[A-Z_][A-Z0-9_]*' {} + 2>/dev/null | \
      sed -e 's/process\.env\.//' -e 's/import\.meta\.env\.//') | sort -u | \
      grep -vE '^(NODE_ENV|PUBLIC_URL|PATH|HOME|USER|SHELL|TERM|LANG|LC_ALL|PWD|OLDPWD|TMPDIR|MODE|DEV|PROD|SSR|BASE_URL)$' | \
      while read var; do \
        uuid=$(echo -n "$var" | md5sum | cut -d' ' -f1); \
        echo "$var=__ENV_NOT_SET__${var}__${uuid}__"; \
      done > /tmp/.env.mappings && \
      echo "Found env vars: $(cat /tmp/.env.mappings | cut -d'=' -f1 | tr '\n' ' ')"
    RUN export $(cat /tmp/.env.mappings | xargs) && {{ .build.vue.buildCommand }}
    FROM nginx:alpine
    RUN apk add --no-cache tzdata wget && addgroup -g 101 nginx-group || true && adduser -u 101 -G nginx-group -s /bin/sh -D nginx-user || true
    COPY --from=build /app{{ .build.vue.distPath | default "/dist" }} /usr/share/nginx/html
    COPY --from=build /tmp/.env.mappings /.env.mappings
    RUN echo 'server { listen 8080; server_name _; root /usr/share/nginx/html; index index.html; add_header X-Frame-Options "SAMEORIGIN" always; add_header X-Content-Type-Options "nosniff" always; add_header X-XSS-Protection "1; mode=block" always; gzip on; gzip_vary on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript; location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { expires 1y; add_header Cache-Control "public, immutable"; } location / { try_files $uri $uri/ /index.html; } location /health { access_log off; return 200 "healthy\\n"; add_header Content-Type text/plain; } }' > /etc/nginx/conf.d/default.conf
    RUN rm -f /etc/nginx/conf.d/default.conf.default
    RUN printf '#!/bin/sh\nset -e\nif [ ! -f /.env.mappings ] || [ ! -s /.env.mappings ]; then\n  exit 0\nfi\nsed_script="/tmp/replace.sed"\n> "$sed_script"\nwhile IFS='\''='\'' read -r key placeholder; do\n  value=$(printenv "$key" || echo "")\n  if [ -n "$value" ]; then\n    escaped=$(printf '\''%%s\\n'\'' "$value" | sed '\''s/[&/\\]/\\\\&/g'\'')\n    echo "s|$placeholder|$escaped|g" >> "$sed_script"\n  fi\ndone < /.env.mappings\nif [ -s "$sed_script" ]; then\n  find /usr/share/nginx/html -type f -name "*.js" -exec sed -i -f "$sed_script" {} +\nfi\nrm -f "$sed_script"\n' > /docker-entrypoint.d/40-inject-env.sh
    RUN chmod +x /docker-entrypoint.d/40-inject-env.sh
    CMD ["nginx", "-g", "daemon off;"]
{{- else if .build.nextjs }}
    FROM node:{{ .build.nextjs.nodeVersion }}-alpine AS build
    RUN corepack enable
    RUN apk add --no-cache coreutils
    WORKDIR /app
    COPY ./ .
    RUN (find . -maxdepth 2 -name ".env*" -type f -exec grep -oE '^[A-Z_][A-Z0-9_]*=' {} + 2>/dev/null | sed 's/=$//' && \
      find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
      ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/build/*" ! -path "*/dist/*" \
      ! -path "*/.yarn/*" ! -path "*/.next/*" ! -path "*/.cache/*" ! -path "*/.turbo/*" \
      ! -path "*/coverage/*" ! -path "*/out/*" \
      -exec grep -ohE 'process\.env\.[A-Z_][A-Z0-9_]*|import\.meta\.env\.[A-Z_][A-Z0-9_]*' {} + 2>/dev/null | \
      sed -e 's/process\.env\.//' -e 's/import\.meta\.env\.//') | sort -u | \
      grep -vE '^(NODE_ENV|PUBLIC_URL|PATH|HOME|USER|SHELL|TERM|LANG|LC_ALL|PWD|OLDPWD|TMPDIR|MODE|DEV|PROD|SSR|BASE_URL|NEXT_PUBLIC_)' | \
      while read var; do \
        uuid=$(echo -n "$var" | md5sum | cut -d' ' -f1); \
        echo "$var=__ENV_NOT_SET__${var}__${uuid}__"; \
      done > /tmp/.env.mappings && \
      echo "Found env vars: $(cat /tmp/.env.mappings | cut -d'=' -f1 | tr '\n' ' ')"
    RUN export $(cat /tmp/.env.mappings | xargs) && {{ .build.nextjs.buildCommand }}
    FROM node:{{ .build.nextjs.nodeVersion }}-alpine
    RUN apk add --no-cache dumb-init tzdata && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    WORKDIR /app
    COPY --from=build --chown=appuser:appgroup /tmp/.env.mappings /.env.mappings
    COPY --from=build --chown=appuser:appgroup /app/.next ./.next
    COPY --from=build --chown=appuser:appgroup /app/public ./public 2>/dev/null || true
    COPY --from=build --chown=appuser:appgroup /app/package.json ./package.json
    COPY --from=build --chown=appuser:appgroup /app/node_modules ./node_modules 2>/dev/null || true
    RUN printf '#!/bin/sh\nset -e\nif [ ! -f /.env.mappings ] || [ ! -s /.env.mappings ]; then\n  exec "$@"\nfi\nsed_script="/tmp/replace.sed"\n> "$sed_script"\nwhile IFS='\''='\'' read -r key placeholder; do\n  value=$(printenv "$key" || echo "")\n  if [ -n "$value" ]; then\n    escaped=$(printf '\''%%s\\n'\'' "$value" | sed '\''s/[&/\\]/\\\\&/g'\'')\n    echo "s|$placeholder|$escaped|g" >> "$sed_script"\n  fi\ndone < /.env.mappings\nif [ -s "$sed_script" ]; then\n  find /app/.next -type f -name "*.js" -exec sed -i -f "$sed_script" {} +\nfi\nrm -f "$sed_script"\nexec "$@"\n' > /entrypoint.sh && chmod +x /entrypoint.sh
    USER appuser
    ENTRYPOINT ["/entrypoint.sh", "dumb-init", "--"]
    {{- $startCmd := (splitList " " (.build.nextjs.startCommand | default "npm start")) }}
    CMD [{{- range $i, $cmd := $startCmd }}{{if $i}}, {{end}}"{{ $cmd }}"{{- end }}]
{{- else if index .build "nextjs-export" }}
    FROM node:{{ index .build "nextjs-export" "nodeVersion" }}-alpine AS build
    RUN corepack enable
    RUN apk add --no-cache coreutils
    WORKDIR /app
    COPY ./ .
    RUN (find . -maxdepth 2 -name ".env*" -type f -exec grep -oE '^[A-Z_][A-Z0-9_]*=' {} + 2>/dev/null | sed 's/=$//' && \
      find . -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
      ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/build/*" ! -path "*/dist/*" \
      ! -path "*/.yarn/*" ! -path "*/.next/*" ! -path "*/.cache/*" ! -path "*/.turbo/*" \
      ! -path "*/coverage/*" ! -path "*/out/*" \
      -exec grep -ohE 'process\.env\.[A-Z_][A-Z0-9_]*|import\.meta\.env\.[A-Z_][A-Z0-9_]*' {} + 2>/dev/null | \
      sed -e 's/process\.env\.//' -e 's/import\.meta\.env\.//') | sort -u | \
      grep -vE '^(NODE_ENV|PUBLIC_URL|PATH|HOME|USER|SHELL|TERM|LANG|LC_ALL|PWD|OLDPWD|TMPDIR|MODE|DEV|PROD|SSR|BASE_URL|NEXT_PUBLIC_)' | \
      while read var; do \
        uuid=$(echo -n "$var" | md5sum | cut -d' ' -f1); \
        echo "$var=__ENV_NOT_SET__${var}__${uuid}__"; \
      done > /tmp/.env.mappings && \
      echo "Found env vars: $(cat /tmp/.env.mappings | cut -d'=' -f1 | tr '\n' ' ')"
    RUN export $(cat /tmp/.env.mappings | xargs) && {{ index .build "nextjs-export" "buildCommand" }}
    FROM nginx:alpine
    RUN apk add --no-cache tzdata wget && addgroup -g 101 nginx-group || true && adduser -u 101 -G nginx-group -s /bin/sh -D nginx-user || true
    COPY --from=build /app{{ index .build "nextjs-export" "distPath" | default "/out" }} /usr/share/nginx/html
    COPY --from=build /tmp/.env.mappings /.env.mappings
    RUN echo 'server { listen 8080; server_name _; root /usr/share/nginx/html; index index.html; add_header X-Frame-Options "SAMEORIGIN" always; add_header X-Content-Type-Options "nosniff" always; add_header X-XSS-Protection "1; mode=block" always; gzip on; gzip_vary on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript; location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { expires 1y; add_header Cache-Control "public, immutable"; } location / { try_files $uri $uri/ /index.html; } location /health { access_log off; return 200 "healthy\\n"; add_header Content-Type text/plain; } }' > /etc/nginx/conf.d/default.conf
    RUN rm -f /etc/nginx/conf.d/default.conf.default
    RUN printf '#!/bin/sh\nset -e\nif [ ! -f /.env.mappings ] || [ ! -s /.env.mappings ]; then\n  exit 0\nfi\nsed_script="/tmp/replace.sed"\n> "$sed_script"\nwhile IFS='\''='\'' read -r key placeholder; do\n  value=$(printenv "$key" || echo "")\n  if [ -n "$value" ]; then\n    escaped=$(printf '\''%%s\\n'\'' "$value" | sed '\''s/[&/\\]/\\\\&/g'\'')\n    echo "s|$placeholder|$escaped|g" >> "$sed_script"\n  fi\ndone < /.env.mappings\nif [ -s "$sed_script" ]; then\n  find /usr/share/nginx/html -type f -name "*.js" -exec sed -i -f "$sed_script" {} +\nfi\nrm -f "$sed_script"\n' > /docker-entrypoint.d/40-inject-env.sh
    RUN chmod +x /docker-entrypoint.d/40-inject-env.sh
    CMD ["nginx", "-g", "daemon off;"]
{{- else if .build.go }}
    FROM golang:{{ .build.go.goVersion }}-alpine AS build
    RUN apk add --no-cache git ca-certificates tzdata
    WORKDIR /app
    COPY go.mod go.sum ./
    RUN go mod download
    COPY ./ .
    RUN CGO_ENABLED=0 GOOS=linux {{ .build.go.buildCommand }}
    FROM alpine:latest
    RUN apk --no-cache add ca-certificates tzdata wget && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    WORKDIR /app
    COPY --from=build --chown=appuser:appgroup /app/{{ .build.go.binaryName | default "main" }} ./{{ .build.go.binaryName | default "main" }}
    USER appuser
    CMD ["./{{ .build.go.binaryName | default "main" }}"]
{{- else if .build.rust }}
    FROM rust:{{ .build.rust.rustVersion }}-alpine AS build
    RUN apk add --no-cache musl-dev openssl-dev pkgconfig
    WORKDIR /app
    COPY Cargo.toml Cargo.lock ./
    RUN mkdir src && echo "fn main() {}" > src/main.rs && cargo build --release && rm -rf src
    COPY ./ .
    RUN {{ .build.rust.buildCommand }}
    FROM alpine:latest
    RUN apk --no-cache add ca-certificates tzdata wget libgcc && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    WORKDIR /app
    COPY --from=build --chown=appuser:appgroup /app/target/release/{{ .build.rust.binaryName | default "app" }} ./{{ .build.rust.binaryName | default "app" }}
    USER appuser
    CMD ["./{{ .build.rust.binaryName | default "app" }}"]
{{- else if .build.maven }}
    FROM eclipse-temurin:{{ .build.maven.javaVersion }}-jdk-alpine AS build
    RUN apk add --no-cache bash findutils
    WORKDIR /app
    ENV MAVEN_OPTS="-XX:-UsePerfData"
    COPY pom.xml ./
    RUN mvn dependency:go-offline -B
    COPY ./ .
    RUN {{ .build.maven.buildCommand }} && rm -rf /tmp/hsperfdata_* /tmp/.java_pid*
    FROM eclipse-temurin:{{ .build.maven.javaVersion }}-jre-alpine
    RUN apk add --no-cache tzdata wget && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    WORKDIR /app
    ENV TZ=Asia/Seoul JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:+UseStringDeduplication -XX:-UsePerfData"
    COPY --from=build --chown=appuser:appgroup /app{{ .build.maven.jarOutputPath | default "/target/*.jar" }} app.jar
    USER appuser
    ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
{{- else if .build.django }}
    FROM python:{{ .build.django.pythonVersion }}-alpine
    RUN apk add --no-cache gcc musl-dev postgresql-dev jpeg-dev zlib-dev freetype-dev lcms2-dev openjpeg-dev tiff-dev tk-dev tcl-dev
    WORKDIR /app
    RUN addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    COPY requirements*.txt ./
    RUN pip install --no-cache-dir -r requirements.txt
    COPY --chown=appuser:appgroup ./ .
    RUN {{ .build.django.buildCommand }}
    USER appuser
    {{- $startCmd := (splitList " " (.build.django.startCommand | default "python manage.py runserver 0.0.0.0:8080")) }}
    CMD [{{- range $i, $cmd := $startCmd }}{{if $i}}, {{end}}"{{ $cmd }}"{{- end }}]
{{- else if .build.flask }}
    FROM python:{{ .build.flask.pythonVersion }}-alpine
    RUN apk add --no-cache gcc musl-dev
    WORKDIR /app
    RUN addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    COPY requirements*.txt ./
    RUN pip install --no-cache-dir -r requirements.txt
    COPY --chown=appuser:appgroup ./ .
    RUN {{ .build.flask.buildCommand }}
    USER appuser
    {{- $startCmd := (splitList " " (.build.flask.startCommand | default "gunicorn -w 4 -b 0.0.0.0:8080 app:app")) }}
    CMD [{{- range $i, $cmd := $startCmd }}{{if $i}}, {{end}}"{{ $cmd }}"{{- end }}]
{{- else if .build.docker }}
    # Custom Dockerfile build
    # Using Dockerfile: {{ .build.docker.dockerfilePath | default "./Dockerfile" }}
    # Build context: {{ .build.docker.contextPath | default "." }}
{{- else }}
    FROM alpine:latest
    RUN apk add --no-cache ca-certificates tzdata && addgroup -g 1001 appgroup && adduser -u 1001 -G appgroup -s /bin/sh -D appuser
    USER appuser
    CMD ["echo", "No build configuration found. Please specify a build type."]
{{- end }}
{{- end }}